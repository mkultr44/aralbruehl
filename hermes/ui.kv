#:kivy 2.3.0

# --- Zeilenobjekt für Ergebnisliste ---
<SelectableRow@Label>:
    index: -1
    selected: True if app.selected_index >= 0 and app.selected_index == self.index else False
    size_hint_y: None
    height: dp(56)
    padding: dp(16), dp(16)
    color: (0, 0, 0, 1)
    canvas.before:
        Color:
            rgba: (0.96, 0.97, 0.99, 1) if self.index % 2 == 0 else (1, 1, 1, 1)
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: (0.0, 0.47, 0.84, 0.18) if getattr(self, 'selected', False) else (0, 0, 0, 0)
        Rectangle:
            pos: self.pos
            size: self.size
    on_touch_down:
        if self.collide_point(*args[1].pos): app.on_result_select(self.index)

# --- Button für Zonenfelder ---
<ZoneButton@ButtonBehavior+Widget>:
    text: ""
    tone: "normal"     # normal | blue | red
    font_size: sp(48)
    size_hint: 1, 1
    canvas.before:
        Color:
            rgba: (1,1,1,1) if self.tone == "normal" else ((0.0, 0.47, 0.84, 1) if self.tone == "blue" else (0.82, 0, 0, 1))
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [18, 18, 18, 18]
        Color:
            rgba: (0.0, 0.47, 0.84, 1) if self.tone == "normal" else (1, 1, 1, 0)
        Line:
            width: 2
            rounded_rectangle: (self.x, self.y, self.width, self.height, 18, 18, 18, 18, 100)
    Label:
        text: root.text
        bold: True
        color: (0, 0, 0, 1) if root.tone == "normal" else (1, 1, 1, 1)
        font_size: root.font_size
        halign: "center"
        valign: "middle"
        text_size: self.size

# --- Header mit Counter ---
<HeaderCounter@BoxLayout>:
    id: header_counter
    size_hint: None, None
    size: self.minimum_size
    spacing: dp(6)
    opacity: 1 if app.einbuchen_mode else 0
    disabled: not app.einbuchen_mode
    Label:
        text: "Eingebucht:"
        color: (1,1,1,1)
        bold: True
        font_size: sp(24)
    Label:
        id: counter_value_label
        text: "0"
        bold: True
        font_size: sp(30)
        color: (1,0,0,1) if app.session_counter == 0 else (0,0.62,0.3,1)

# --- Overlay für Protokoll ---
<LogView@ModalView>:
    auto_dismiss: True
    background_color: 0,0,0,0.4
    overlay_color: 0,0,0,0.4
    BoxLayout:
        orientation: "vertical"
        padding: dp(16)
        spacing: dp(12)
        size_hint: 0.9, 0.8
        pos_hint: {"center_x": 0.5, "center_y": 0.5}
        canvas.before:
            Color:
                rgba: (1,1,1,1)
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [16,16,16,16]
        BoxLayout:
            size_hint_y: None
            height: dp(48)
            Label:
                text: "Protokoll"
                color: (0,0,0,1)
                bold: True
                font_size: sp(20)
            Button:
                text: "Schließen"
                size_hint_x: None
                width: dp(140)
                on_release: root.dismiss()
        ScrollView:
            do_scroll_x: False
            GridLayout:
                id: log_container
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                padding: dp(8), dp(8)
                spacing: dp(6)
                Label:
                    text: "\\n".join(app.log_lines)
                    color: (0,0,0,1)
                    font_size: sp(16)
                    halign: "left"
                    valign: "top"
                    text_size: self.width, None

# --- Hauptlayout ---
<Root@BoxLayout>:
    orientation: "vertical"
    canvas.before:
        Color:
            rgba: 1,1,1,1
        Rectangle:
            pos: self.pos
            size: self.size

    # Header
    BoxLayout:
        size_hint_y: None
        height: dp(80)
        padding: dp(16), dp(12)
        spacing: dp(12)
        canvas.before:
            Color:
                rgba: (0.0, 0.47, 0.84, 1)
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            id: status_label
            text: app.zone_status
            color: (1,1,1,1)
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            font_size: sp(26)
        HeaderCounter:
        Button:
            text: "Protokoll"
            size_hint_x: None
            width: dp(160)
            on_release: app.open_log_overlay()

    # Eingabezeile
    BoxLayout:
        size_hint_y: None
        height: dp(90)
        padding: dp(16), 0
        spacing: dp(12)
        Label:
            text: "Eingabe (Scan / Suche):"
            color: (0,0,0,1)
            font_size: sp(22)
            size_hint_x: None
            width: dp(330)
            valign: "middle"
            text_size: self.size
        TextInput:
            id: scanner_input
            multiline: False
            font_size: sp(26)
            size_hint_x: None
            width: dp(500)
            on_text_validate: app.on_text_validate()
            on_text: app.on_scanner_text(self.text)
        Button:
            text: "Suchen"
            size_hint_x: None
            width: dp(160)
            on_release: app.on_search_button()
        Button:
            text: "Clear"
            size_hint_x: None
            width: dp(140)
            on_release: app.on_clear_button()

    # Hauptbereich
    BoxLayout:
        padding: dp(16)
        spacing: dp(16)

        # Linke Zone
        BoxLayout:
            orientation: "vertical"
            size_hint_x: 0.62
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                Widget:
                Label:
                    id: zone_warning
                    text: "Zone auswählen!"
                    color: (1,1,1,1)
                    bold: True
                    font_size: sp(24)
                    size_hint_x: None
                    width: dp(300)
                    opacity: 0
                    canvas.before:
                        Color:
                            rgba: (0.82, 0, 0, 1)
                        RoundedRectangle:
                            radius: [10,10,10,10]
                            pos: self.pos
                            size: self.size
                Widget:

            GridLayout:
                cols: 3
                rows: 4
                spacing: dp(12)
                padding: 0, dp(12), dp(12), dp(12)
                ZoneButton:
                    id: zone_A
                    text: "A"
                    on_release: app.set_zone("A")
                ZoneButton:
                    id: zone_B
                    text: "B"
                    on_release: app.set_zone("B")
                ZoneButton:
                    id: zone_C
                    text: "C"
                    on_release: app.set_zone("C")
                ZoneButton:
                    id: zone_D
                    text: "D"
                    on_release: app.set_zone("D")

            GridLayout:
                cols: 5
                spacing: dp(12)
                padding: 0, 0, dp(12), dp(4)
                ZoneButton:
                    id: zone_E_1
                    text: "E-1"
                    font_size: sp(42)
                    on_release: app.set_zone("E-1")
                ZoneButton:
                    id: zone_E_2
                    text: "E-2"
                    font_size: sp(42)
                    on_release: app.set_zone("E-2")
                ZoneButton:
                    id: zone_E_3
                    text: "E-3"
                    font_size: sp(42)
                    on_release: app.set_zone("E-3")
                ZoneButton:
                    id: zone_E_4
                    text: "E-4"
                    font_size: sp(42)
                    on_release: app.set_zone("E-4")
                ZoneButton:
                    id: zone_F
                    text: "F"
                    font_size: sp(42)
                    on_release: app.set_zone("F")

        # Rechte Zone (Steuerung + Ergebnisse)
        BoxLayout:
            orientation: "vertical"
            size_hint_x: 0.38
            spacing: dp(12)

            Button:
                id: einbuchen_btn
                text: "Einbuchen"
                size_hint_y: None
                height: dp(90)
                on_release: app.toggle_einbuchen()

            BoxLayout:
                orientation: "vertical"
                opacity: 0 if app.einbuchen_mode else 1
                disabled: app.einbuchen_mode
                padding: dp(8)
                canvas.before:
                    Color:
                        rgba: (1,1,1,1)
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [12,12,12,12]
                BoxLayout:
                    size_hint_y: None
                    height: dp(48)
                    padding: dp(8), 0
                    Label:
                        text: "Pakete"
                        color: (0,0,0,1)
                        bold: True
                        font_size: sp(20)
                ScrollView:
                    do_scroll_x: False
                    RecycleView:
                        id: rv
                        data: app.result_items
                        viewclass: "SelectableRow"
                        RecycleBoxLayout:
                            default_size: None, dp(56)
                            default_size_hint: 1, None
                            size_hint_y: None
                            height: self.minimum_height
                BoxLayout:
                    size_hint_y: None
                    height: dp(70)
                    spacing: dp(12)
                    padding: dp(8), dp(8)
                    Button:
                        text: "Treffer löschen"
                        on_release: app.on_delete_button()
                    Button:
                        text: "Alle anzeigen"
                        on_release: app.on_all_button()

